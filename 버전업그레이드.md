# MDesk 버전 업그레이드 가이드

## 버전 정의 파일

### 1. Rust 버전 (메인) - 필수 변경
**파일**: `src/version.rs`
```rust
pub const VERSION: &str = "1.4.4";
pub const BUILD_DATE: &str = "2026-01-01 23:04";
```

### 2. Cargo.toml (패키지 버전) - 필수 변경
**파일**: `Cargo.toml` (3번 줄)
```toml
version = "1.4.4"
```

### 3. Flutter pubspec.yaml - 필수 변경
**파일**: `flutter/pubspec.yaml` (19번 줄)
```yaml
version: 1.4.5+1
```

### 4. Portable 패커 버전 (MDesk_portable.exe 파일 속성) - 필수 변경 ⭐
**파일**: `libs/portable/Cargo.toml` (3번 줄)
```toml
version = "1.4.7"
```

**중요**: `MDesk_portable.exe`는 portable 패커로 압축된 최종 배포 파일입니다.
- `winres` 크레이트가 `Cargo.toml`의 `version`을 자동으로 읽어서 Windows 리소스에 삽입합니다.
- 이 버전이 실제 사용자에게 보이는 파일 속성 버전입니다.

### 5. Windows 실행 파일 버전 (MDesk.exe 파일 속성) - 선택 변경
**파일**: `flutter/windows/runner/Runner.rc` (66, 72, 94, 99번 줄)
```c
#define VERSION_AS_NUMBER 1,4,5,0  // MAJOR,MINOR,PATCH,BUILD
#define VERSION_AS_STRING "1.4.5"
VALUE "FileVersion", "1.4.5.0" "\0"
VALUE "ProductVersion", "1.4.5" "\0"
```

**참고**: `MDesk.exe`는 portable 패키징 전의 Flutter 빌드 파일입니다.
- 실제 배포되는 `MDesk_portable.exe`의 버전은 `libs/portable/Cargo.toml`에서 결정됩니다.

---

## 버전 업그레이드 절차

### Step 1: 버전 번호 변경
1. `src/version.rs` 파일 열기
2. `VERSION` 상수 값 변경 (예: `"1.4.4"` → `"1.4.5"`)
3. `BUILD_DATE` 업데이트 (현재 날짜로)

### Step 2: Cargo.toml 동기화
1. `Cargo.toml` 파일 열기
2. `version = "1.4.5"` 로 변경

### Step 3: Flutter 버전 동기화
1. `flutter/pubspec.yaml` 파일 열기
2. `version: 1.4.5+1` 로 변경

### Step 4: Portable 패커 버전 설정 (가장 중요!) ⭐
1. `libs/portable/Cargo.toml` 파일 열기
2. 3번 줄: `version = "1.4.7"` 로 변경
3. 이것이 `MDesk_portable.exe`의 파일 속성 버전이 됩니다!

### Step 5: Windows 실행 파일 버전 설정 (선택)
1. `flutter/windows/runner/Runner.rc` 파일 열기
2. 66번 줄: `#define VERSION_AS_NUMBER 1,4,5,0` 로 변경
3. 72번 줄: `#define VERSION_AS_STRING "1.4.5"` 로 변경
4. 94번 줄: `VALUE "FileVersion", "1.4.5.0"` 로 변경
5. 99번 줄: `VALUE "ProductVersion", "1.4.5"` 로 변경

### Step 6: 빌드 캐시 정리 (중요!)
```bash
cd flutter
flutter clean
rmdir /s /q build
rmdir /s /q .dart_tool
```

### Step 6: 빌드
```bash
# 프로젝트 루트에서
set VCPKG_ROOT=D:\IMedix\Rust\vcpkg
build_windows.bat
```

### Step 8: 서버 업로드
1. 빌드된 `MDesk_portable.exe`를 서버에 업로드
2. API 서버에서 새 버전 정보가 자동 반영됨

---

## 버전 체크 시스템

### API 엔드포인트
```
GET https://admin.787.kr/api/version/latest
```

### API 응답 예시
```json
{
  "code": 1,
  "msg": "버전 정보 조회 성공",
  "data": {
    "file_name": "MDesk_portable.exe",
    "file_version": "1.4.5",
    "product_version": "1.4.5",
    "product_name": "MDesk",
    "file_description": "MDesk Remote Desktop"
  }
}
```

### 버전 비교 로직
- 클라이언트 현재 버전: `src/version.rs`의 `VERSION` 값
- 서버 최신 버전: API 응답의 `data.file_version` 값
- 비교: 서버 버전 > 클라이언트 버전이면 업데이트 알림 표시

---

## 버전 형식

### Semantic Versioning (권장)
```
MAJOR.MINOR.PATCH
예: 1.4.5
```

- **MAJOR**: 호환되지 않는 큰 변경
- **MINOR**: 하위 호환되는 기능 추가
- **PATCH**: 버그 수정

### 버전 비교 방식
```
1.4.5  →  1 * 1000000 + 4 * 1000 + 5 * 10 = 1004050
1.4.4  →  1 * 1000000 + 4 * 1000 + 4 * 10 = 1004040
```
숫자가 더 크면 새 버전

---

## 관련 코드 위치

| 파일 | 역할 |
|------|------|
| `src/version.rs` | 현재 버전 정의 |
| `Cargo.toml` | 패키지 버전 |
| `flutter/lib/common.dart` | `checkMDeskUpdate()` - 버전 체크 API 호출 |
| `flutter/lib/models/state_model.dart` | `updateUrl`, `latestVersion` 상태 저장 |
| `flutter/lib/desktop/pages/desktop_home_page.dart` | `buildHelpCards()` - 업데이트 알림 UI |

---

## 테스트 방법

### 업데이트 알림 테스트
1. `src/version.rs`에서 버전을 낮춤 (예: `1.4.3`)
2. 앱 빌드 및 실행
3. 서버 버전(`1.4.4`)이 더 높으므로 업데이트 알림 표시됨

### 디버그 로그 확인
앱 실행 시 콘솔에서 다음 로그 확인:
```
MDesk Update Check: Current version = 1.4.3
MDesk Update Check: Latest version = 1.4.4
MDesk Update Check: New version available! 1.4.4 > 1.4.3
MDesk Update Check: Download URL = https://admin.787.kr/download/MDesk_portable.exe
```

---

## 체크리스트

버전 업그레이드 시 확인할 사항:

- [ ] `src/version.rs` 버전 변경
- [ ] `Cargo.toml` 버전 동기화
- [ ] `flutter/pubspec.yaml` 버전 동기화
- [ ] **`libs/portable/Cargo.toml` 버전 변경** ⭐ (MDesk_portable.exe 파일 속성용)
- [ ] `flutter/windows/runner/Runner.rc` 버전 변경 (MDesk.exe 파일 속성용, 선택)
- [ ] `flutter clean` 실행 (빌드 캐시 정리)
- [ ] 빌드 테스트 통과
- [ ] 빌드된 EXE 파일 속성에서 버전 확인 (우클릭 → 속성 → 세부정보)
- [ ] 서버에 새 실행파일 업로드
- [ ] API에서 새 버전 정보 확인
- [ ] 구버전 클라이언트에서 업데이트 알림 확인

---

## 문제 해결

### EXE 파일 속성에 버전이 반영되지 않는 경우

**중요**: `MDesk_portable.exe`의 버전은 `libs/portable/Cargo.toml`에서 결정됩니다!

1. **Portable 패커 버전 확인** (가장 중요!)
   - `libs/portable/Cargo.toml` 파일의 `version` 필드 확인
   - 예: `version = "1.4.7"`

2. **빌드 캐시 완전 삭제**
   ```bash
   cd flutter
   flutter clean
   rmdir /s /q build
   rmdir /s /q .dart_tool
   
   cd ..
   cd libs/portable
   cargo clean
   cd ../..
   ```

3. **전체 재빌드**
   - 프로젝트 루트에서 `build_windows.bat` 실행
   - Portable 패커가 다시 빌드되면서 새 버전이 적용됨

### 버전이 여전히 안 바뀌는 경우

- `libs/portable/target/release/` 폴더 삭제 후 재빌드
- `winres` 크레이트가 `Cargo.toml`의 버전을 자동으로 읽으므로, 버전 변경 후 반드시 재빌드 필요

